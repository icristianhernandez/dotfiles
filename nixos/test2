{ config, pkgs, ... }:

{
  # Import NixOS hardware profile for ThinkPad E14 (adjust based on your generation/variant)
  # For Intel-based E14: <nixos-hardware/lenovo/thinkpad/e14/intel>
  # For AMD-based: <nixos-hardware/lenovo/thinkpad/e14/amd>
  # Example for Intel Gen 2+ (common for ALC257 issues):
  # imports = [ <nixos-hardware/lenovo/thinkpad/e14/intel> ];

  # Ensure SOF firmware is installed for modern Realtek codecs like ALC257
  # This provides topology and firmware needed for proper detection and DSP features.
  hardware.firmware = [ pkgs.sof-firmware ];

  # Disable legacy ALSA sound (PipeWire replaces it)
  sound.enable = false;

  # Enable realtime scheduling (recommended for low-latency audio)
  security.rtkit.enable = true;

  # Enable PipeWire as the modern sound server
  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;  # PulseAudio compatibility
    # jack.enable = true;  # Uncomment if you use JACK apps
  };

  # Install EasyEffects for advanced audio processing (GUI for effects on PipeWire)
  # It includes RNNoise-based noise reduction and WebRTC echo cancellation.
  environment.systemPackages = with pkgs; [
    easyeffects
    # Optional: qpwgraph for visualizing PipeWire graphs
    # qpwgraph
  ];

  # Optional: Auto-start EasyEffects as a daemon for always-on effects
  # (User-level via Home Manager recommended for per-user presets)
  # But system-wide example:
  # systemd.services.easyeffects = {
  #   description = "EasyEffects daemon";
  #   wantedBy = [ "graphical-session.target" ];
  #   partOf = [ "graphical-session.target" ];
  #   serviceConfig = {
  #     ExecStart = "${pkgs.easyeffects}/bin/easyeffects --gapplication-service";
  #     ExecStop = "${pkgs.easyeffects}/bin/easyeffects --quit";
  #     Restart = "on-failure";
  #   };
  # };
}
