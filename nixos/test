{
  config,
  pkgs,
  ...
}:
{
  # Enable sound with PipeWire
  sound.enable = true;
  hardware.pulseaudio.enable = false;

  # PipeWire configuration
  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
    # Optional: Enable JACK if needed for audio applications
    # jack.enable = true;
  };

  # Install necessary packages for audio improvements
  environment.systemPackages = with pkgs; [
    easyeffects # For advanced audio processing, including potential Dolby-like enhancements via presets
    rnnoise-plugin # LADSPA plugin for noise suppression
    sof-firmware # Firmware for Intel audio DSP, common in ThinkPads
    alsa-firmware # Additional ALSA firmware for Realtek codecs
  ];

  # Firmware compression for better hardware support
  hardware.firmware = with pkgs; [
    sof-firmware
    alsa-firmware
  ];

  # Optional: Kernel module options for Realtek HDA codec
  boot.extraModprobeConfig = ''
    options snd-hda-intel model=auto
  '';

  # System-wide PipeWire configuration for noise suppression using rnnoise
  # This creates a virtual microphone source with noise reduction
  environment.etc."pipewire/pipewire.conf.d/99-noise-suppression.conf".text = ''
    context.modules = [
      { name = libpipewire-module-filter-chain
        args = {
          node.description = "Noise Canceling source"
          media.name = "Noise Canceling source"
          filter.graph = {
            nodes = [
              {
                type = ladspa
                name = rnnoise
                plugin = ${pkgs.rnnoise-plugin}/lib/ladspa/librnnoise_ladspa.so
                label = noise_suppressor_stereo
                control = {
                  "VAD Threshold (%)" = 50.0
                }
              }
            ]
          }
          capture.props = {
            node.name = "capture.rnnoise_source"
            node.passive = true
          }
          playback.props = {
            node.name = "rnnoise_source"
            media.class = Audio/Source
            node.passive = false
          }
        }
      }
    ]
  '';

  # System-wide PipeWire configuration for echo cancellation
  # This creates virtual sources and sinks for echo-cancelled audio
  environment.etc."pipewire/pipewire.conf.d/99-echo-cancellation.conf".text = ''
    context.modules = [
      { name = libpipewire-module-echo-cancel
        args = {
          monitor.mode = true
          capture.props = {
            node.passive = true
          }
          source.props = {
            node.name = "echo_cancel_source"
            node.description = "Echo Cancel Source"
          }
          sink.props = {
            node.name = "echo_cancel_sink"
            node.description = "Echo Cancel Sink"
          }
          aec.args = {
            webrtc.extended_filter = false
          }
        }
      }
    ]
  '';

  # Notes:
  # - After applying this configuration, restart PipeWire services or reboot.
  # - Select the "Noise Canceling source" and "Echo Cancel Source" in your audio settings (e.g., in pavucontrol or system sound settings) for input.
  # - For output improvements on Realtek ALC257 with Dolby certification, full proprietary Dolby support is limited on Linux. Use EasyEffects to apply equalizer presets or convolution filters. A community project provides impulse responses for ThinkPad speakers to mimic Dolby effects.
  # - If microphone or speaker issues persist, ensure the correct firmware is loaded and check dmesg for audio-related errors.
}
