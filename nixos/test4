

To achieve high-quality audio output (simulating Dolby-like effects) and professional-grade noise suppression for your Realtek ALC257 on a ThinkPad E14, we will use **PipeWire** as the audio engine and **EasyEffects** (formerly PulseEffects) for advanced DSP (Digital Signal Processing).

Since the proprietary "Dolby Audio" drivers are exclusive to Windows, we use open-source DSP filters in Linux to replicate the wide soundstage, clarity, and noise cancellation.

Here is the complete configuration split into **System Configuration** (`configuration.nix`) and **User Configuration** (`home.nix`).

### 1. System Configuration (`/etc/nixos/configuration.nix`)

This configuration sets up PipeWire, ensures the Intel/Realtek firmware (SOF) is loaded (crucial for ALC257), and enables the required audio frameworks.

```nix
{ config, pkgs, ... }:

{
  # ... existing configuration ...

  # 1. Enable PipeWire Audio Stack
  # Replaces PulseAudio and offers lower latency and better performance
  sound.enable = false;
  hardware.pulseaudio.enable = false;
  security.rtkit.enable = true;
  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
    # If you use JACK applications, uncomment the next line
    # jack.enable = true;
  };

  # 2. Firmware for Intel/Realtek Audio (ALC257)
  # The ALC257 on the ThinkPad E14 typically relies on the Sound Open Firmware (SOF)
  # project for correct routing and DSP capabilities.
  hardware.sof-firmware.enable = true;

  # 3. Ensure correct UCM (Use Case Manager) configurations are loaded
  # This helps with headphone detection and internal mic routing on ThinkPads
  hardware.alsa.enablePersistentTimestamps = true;

  # ... existing configuration ...
}
```

### 2. User Configuration (Home Manager)

We will install **EasyEffects** and **LSP Plugins** (Linux Studio Plugins). EasyEffects acts as a graphical wrapper to manage the processing pipelines (LADSPA, LV2 filters).

Add this to your Home Manager configuration (e.g., `~/.config/nixpkgs/home.nix` or your flake):

```nix
{ config, pkgs, ... }:

{
  # ... existing home config ...

  home.packages = with pkgs; [
    easyeffects
    # LSP (Linux Studio Plugins) provides high-quality compressors and EQs
    # essential for simulating "Dolby" surround and loudness.
    lsp-plugins
  ];

  # Enable EasyEffects as a systemd service to start it automatically on login
  systemd.user.services.easyeffects = {
    Unit = {
      Description = "EasyEffects Service";
      After = [ "graphical-session.target" ];
      PartOf = [ "graphical-session.target" ];
    };
    Service = {
      ExecStart = "${pkgs.easyeffects}/bin/easyeffects --gapplication-service";
      Restart = "on-failure";
    };
    Install.WantedBy = [ "graphical-session.target" ];
  };

  # Optional: Persist EasyEffects presets so they survive rebuilds
  # Ensure your .config directory is managed correctly or manually copy presets.
  home.file.".config/easyeffects/input".source = ./config/easyeffects/input;
  home.file.".config/easyeffects/output".source = ./config/easyeffects/output;

  # ... existing home config ...
}
```

---

### 3. Post-Configuration Setup (How to tune)

After applying the configurations (`nixos-rebuild switch` and `home-manager switch`), you need to configure the DSP effects within the EasyEffects GUI (search for "EasyEffects" in your app menu).

#### A. Output: Simulating Dolby Audio (Speakers/Headphones)
Dolby Audio typically emphasizes dialogue clarity, bass enhancement, and spatial widening. Replicate this in EasyEffects:

1.  Open EasyEffects, go to the **Presets** menu and save a new preset (e.g., `DolbySim`).
2.  Enable the following plugins in this order:
    *   **Bass Enhancer:** Set amount to roughly 10-15 dB. This mimics the low-end boost of Dolby.
    *   **Compressor:** (Use LSP Compressor). Set ratio to ~4:1 and threshold to -20 dB. This makes the sound "punchier" and more consistent (Loudness).
    *   **Loudness:** Enable "Bass" and "Treble" boost knobs slightly.
    *   **Equalizer:** Use a "V-shape" curve (boost Treble and Bass, cut Mids slightly) to enhance spatial cues.
    *   **Stereo Tools:** (Optional) Enable "Stereo Width" to ~120% to simulate surround sound from stereo speakers.
3.  **Activate Output:** Click the "Output" tab in EasyEffects and ensure the "Limiter" is on at the very end of the chain to prevent clipping (distortion).

#### B. Input: Noise Suppression & Echo Cancellation (Microphone)

1.  Switch to the **Input** tab in EasyEffects.
2.  Enable the following plugins:
    *   **Noise Reduction:** (RNNoise). This is a Recurrent Neural Network based filter. It is the best open-source noise suppressor. Enable it.
    *   **High Pass Filter:** Set frequency to ~80-100Hz to cut low-frequency rumble (fan noise).
    *   **Compressor:** To even out your voice volume.
    *   **Echo Cancellation:** (Optional). EasyEffects has a built-in echo canceller filter, but PipeWire's native echo cancellation (module-echo-cancel) is often more robust if you experience feedback. If using the plugin, enable "Spectral Acoustic Echo Cancellation" (SAEC) if available.
3.  Select your microphone as the input source in EasyEffects and ensure the "Output" of EasyEffects is set to your main recording target.

---

### 4. Sources & Technical Justification

1.  **PipeWire & SOF Firmware:**
    *   The **Realtek ALC257** on modern ThinkPads (like the E14 Gen 2/3) utilizes the **Intel Sound Open Firmware (SOF)**. Without `sof-firmware`, the card often falls back to legacy mode or fails to route the internal mic correctly.
    *   *Source:* [The Linux Kernel documentation on SOF](https://www.sofproject.org/) and [ALSA project](https://www.alsa-project.org/wiki/Main_Page).

2.  **EasyEffects vs. PulseEffects:**
    *   EasyEffects is the actively maintained successor to PulseEffects. It utilizes LV2 plugins (like `lsp-plugins`) which provide studio-grade DSP comparable to consumer enhancements like Dolby.
    *   *Source:* [EasyEffects GitHub](https://github.com/wwmm/easyeffects).

3.  **RNNoise for Input:**
    *   RNNoise (Recurrent Neural Network noise suppression) is the industry standard for high-quality AI noise removal in Linux. It is significantly superior to traditional noise gates.
    *   *Source:* [Jean-Marc Valin's RNNoise paper](https://people.xiph.org/~jm/demo/rnnoise/) and implementation in EasyEffects.

4.  **ALC257 Specifics:**
    *   This codec is a Common HD Audio codec. Issues with internal microphone static or "dead" speakers are almost always solved by the combination of `sof-firmware` and proper ALSA UCM (Use Case Manager) configuration, which PipeWire utilizes automatically.
    *   *Reference:* [ArchWiki Audio Configuration](https://wiki.archlinux.org/title/Advanced_Linux_Sound_Architecture).
