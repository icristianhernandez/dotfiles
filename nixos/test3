This configuration is designed for a **ThinkPad E14** running NixOS. It addresses the two main goals:
1.  **Input:** Professional-grade noise suppression and echo cancellation using PipeWire's filter chains and `rnnoise`.
2.  **Output:** Dolby Audio-like sound enhancement using **EasyEffects** with a "Loudness" preset, which mimics the punchy, clear audio usually provided by the proprietary Windows driver.

### Prerequisites
*   **NixOS** (System-level config)
*   **Home Manager** (User-level config) - *Highly recommended for managing the complex PipeWire and EasyEffects configurations declaratively.*

---

### Part 1: System Configuration (`/etc/nixos/configuration.nix`)
This sets up the low-level audio plumbing. We use **PipeWire** as it is the modern standard and required for these plugins. We also use the latest kernel, which is critical for ThinkPad E14 microphone detection (especially AMD Gen 2-6 models).

```nix
{ config, pkgs, ... }:

{
  # 1. Hardware Support & Kernel
  # Newer ThinkPads often need the latest kernel for internal mic/speaker quirks
  boot.kernelPackages = pkgs.linuxPackages_latest;

  # 2. Enable RealtimeKit
  # Critical for low-latency audio processing to prevent crackling
  security.rtkit.enable = true;

  # 3. Enable PipeWire
  # Disable PulseAudio and enable PipeWire with full compatibility
  services.pulseaudio.enable = false;
  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true; # PulseAudio drop-in replacement
    
    # If you want to use JACK applications:
    # jack.enable = true;
  };
  
  # 4. System Packages
  environment.systemPackages = with pkgs; [
    pulseaudio  # For pactl/pacmd command line tools
    pavucontrol # GUI for volume control (essential for testing)
  ];
}
```

---

### Part 2: Home Manager Configuration (`home.nix`)
This is where the magic happens. We will declaratively configure:
1.  **Input:** A noise-canceling microphone source using the `rnnoise` library.
2.  **Output:** EasyEffects with a custom preset to improve laptop speaker quality.

```nix
{ config, pkgs, ... }:

{
  home.packages = with pkgs; [
    easyeffects
    rnnoise-plugin # The library for noise suppression
  ];

  # 1. PipeWire Configuration for Noise Cancellation (Input)
  # This creates a file at ~/.config/pipewire/pipewire.conf.d/99-input-denoising.conf
  # It creates a virtual microphone named "Noise Canceling Source"
  xdg.configFile."pipewire/pipewire.conf.d/99-input-denoising.conf".text = ''
    context.modules = [
    {   name = libpipewire-module-filter-chain
        args = {
            node.description =  "Noise Canceling Source"
            media.name =  "Noise Canceling Source"
            filter.graph = {
                nodes = [
                    {
                        type = ladspa
                        name = rnnoise
                        plugin = ${pkgs.rnnoise-plugin}/lib/ladspa/librnnoise_ladspa.so
                        label = noise_suppressor_mono
                        control = {
                            "VAD Threshold (%)" = 50.0
                            "VAD Grace Period (ms)" = 200
                            "Retroactive VAD Grace (ms)" = 20
                        }
                    }
                ]
            }
            capture.props = {
                node.name =  "capture.rnnoise_source"
                node.passive = true
                audio.rate = 48000
            }
            playback.props = {
                node.name =  "rnnoise_source"
                media.class = Audio/Source
                audio.rate = 48000
            }
        }
    }
    ]
  '';

  # 2. EasyEffects Configuration for Dolby-like Audio (Output)
  # We start EasyEffects as a service in the background
  services.easyeffects.enable = true;

  # 3. Create a "Laptop Boost" Preset
  # This mimics Dolby Audio by boosting bass presence and clarifying speech.
  # Placed in ~/.config/easyeffects/output/LaptopBoost.json
  xdg.configFile."easyeffects/output/LaptopBoost.json".text = builtins.toJSON {
    output = {
      blocklist = [];
      "plugins_order" = [
        "bass_enhancer"
        "crystalizer"
        "limiter"
      ];
      "bass_enhancer" = {
        "amount" = 5.0;
        "bypass" = false;
        "floor" = 20.0;
        "floor-active" = true;
        "harmonics" = 8.5;
        "scope" = 100.0;
      };
      "crystalizer" = {
        "band-limits" = "500 2000 8000";
        "bypass" = false;
        "intensities" = "1.0 1.0 1.0";
        "mute-bands" = "0 0 0";
      };
      "limiter" = {
        "bypass" = false;
        "input-gain" = 2.0; # Slight volume boost
        "limit" = -1.0;     # Prevent clipping
      };
    };
  };
}
```

### Setup & Usage Guide

#### 1. Activate the Changes
Run your rebuild command (e.g., `sudo nixos-rebuild switch` or `home-manager switch`).

#### 2. Input: Enabling Noise Cancellation
After rebuilding, PipeWire will auto-load your new config.
1.  Open **Pavucontrol** (Volume Control) or your meeting software (Zoom/Teams).
2.  Go to the **Input Devices** tab.
3.  You will see a new device called **"Noise Canceling Source"**.
4.  **Select this device** as your default microphone in your apps. It filters the audio from your built-in mic through `rnnoise` before sending it to the app.

#### 3. Output: Enabling "Dolby" Sound
1.  Open the **EasyEffects** application (it should be running in the tray).
2.  Click the **"Presets"** button on the top left.
3.  Select **"LaptopBoost"** (the file we created) and click "Load".
4.  **Important:** To make this automatic:
    *   In EasyEffects, go to the **PipeWire** tab (top right).
    *   Find "Presets Autoloading".
    *   Select your "Family 17h/19h HD Audio Controller" (your Realtek speakers) as the device.
    *   Select "LaptopBoost" as the preset.
    *   Click the `+` button.
    *   *Now, whenever you unplug headphones and use speakers, this effect will auto-apply.*

### Why this setup?
*   **Echo Cancellation:** PipeWire has a built-in `libpipewire-module-echo-cancel` module, but the `rnnoise` filter chain configured above is generally superior for background noise (typing, fans) which is the primary complaint on ThinkPads. If you strictly need acoustic echo cancellation (hearing your own voice loopback), most modern apps (Zoom/Teams) handle this natively better than the Linux driver level.
*   **Dolby Replacement:** Dolby Audio on Windows essentially applies a Dynamic EQ and a Bass Enhancer. The **EasyEffects** `bass_enhancer` (adds harmonics to simulate deeper bass on small speakers) and `crystalizer` (restores high-end clarity) plugins recreate this effect almost perfectly without proprietary blobs.
*   **ThinkPad Quirks:** The `boot.kernelPackages = pkgs.linuxPackages_latest` line is crucial. ThinkPad E14 AMD models often have "unplugged" microphone bugs that are only fixed in kernel 6.6+ (which `latest` provides).
