for agent: idempotent migration files

configure well sqls and check SELECT 1;

1. Local Supbase (done)
   1.1) Connect nvim to the DB? And ensure toolkits (lsp, etc)
   1.5) check all missign things to achieve that DB
2. All DB scheming
   2.a) scheming
   2.b) rls
   2.c) machine and autologic
   2.d) blob, vaults, documents

lookup for:

- uniqueness in data
- relations
- defaults value
- integrity (x value, need to have a y value, based on z workflow)
- also integrity (well formatted data)
- data that need to hold value
- ensure idempotency
- correct datatype

/*
 * ACADEMIC SERVICE MANAGEMENT SYSTEM - BOOTSTRAP SCRIPT
 * -----------------------------------------------------
 * Author: Senior Database Architect
 * Platform: Supabase (PostgreSQL)
 * 
 * CONTENTS:
 * 1. Extensions & Enums
 * 2. Lookup Tables (Faculties, Schools, Institutions)
 * 3. User Profiles & RBAC Structure
 * 4. Core Tables (Students, Projects)
 * 5. Audit Logging System
 * 6. Immutability Triggers
 * 7. Row Level Security (RLS) Policies
 */

-- 1. EXTENSIONS & ENUMS
-- -----------------------------------------------------

-- Enable citext for case-insensitive email/text comparisons
CREATE EXTENSION IF NOT EXISTS citext;

-- Enum for User Roles to handle the hierarchy
CREATE TYPE app_role AS ENUM (
    'student',
    'coordinator',       -- School Coordinator
    'director',          -- School Director
    'dean',              -- Faculty Dean
    'planning',          -- Planning & Admission
    'vicerector',        -- Academic Vicerectorate
    'rector'             -- Rectorate
);

-- Enum for Semesters
CREATE TYPE semester_enum AS ENUM ('1', '2', '3', '4', '5', '6', '7', '8', '9', '10');

-- Enum for Turns
CREATE TYPE turn_enum AS ENUM ('morning', 'afternoon', 'night');

-- 2. LOOKUP TABLES
-- -----------------------------------------------------

CREATE TABLE faculties (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE schools (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    faculty_id BIGINT REFERENCES faculties(id) ON DELETE RESTRICT,
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE institutions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    address TEXT,
    contact_person TEXT,
    contact_phone TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. USER PROFILES & RBAC
-- -----------------------------------------------------
-- This table extends auth.users to store role and scope (Faculty/School)
CREATE TABLE profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    first_name TEXT,
    last_name TEXT,
    role app_role DEFAULT 'student',
    
    -- Scope for RBAC:
    -- Deans are assigned to a faculty_id
    -- Directors/Coordinators are assigned to a school_id
    assigned_faculty_id BIGINT REFERENCES faculties(id),
    assigned_school_id BIGINT REFERENCES schools(id),
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    CONSTRAINT chk_role_scope CHECK (
        (role = 'dean' AND assigned_faculty_id IS NOT NULL) OR
        (role IN ('director', 'coordinator') AND assigned_school_id IS NOT NULL) OR
        (role IN ('student', 'rector', 'vicerector', 'planning'))
    )
);

-- 4. CORE TABLES
-- -----------------------------------------------------

CREATE TABLE students (
    id UUID REFERENCES auth.users(id) PRIMARY KEY, -- 1:1 Link with Auth
    ci TEXT NOT NULL UNIQUE, -- CÃ©dula de Identidad
    first_name TEXT NOT NULL,
    last_name TEXT NOT NULL,
    email CITEXT NOT NULL,
    
    -- Contact Numbers (Up to 2 spaces)
    phone_primary TEXT NOT NULL,
    phone_secondary TEXT,
    
    -- Academic Info
    faculty_id BIGINT REFERENCES faculties(id),
    school_id BIGINT REFERENCES schools(id),
    semester semester_enum NOT NULL,
    turn turn_enum NOT NULL,
    section TEXT NOT NULL,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE projects (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id UUID REFERENCES students(id) NOT NULL,
    institution_id BIGINT REFERENCES institutions(id),
    
    -- Part 2: Project Details
    name TEXT NOT NULL,
    general_objective TEXT NOT NULL,
    
    -- Specific Objectives (4 separate columns as requested)
    specific_objective_1 TEXT,
    specific_objective_2 TEXT,
    specific_objective_3 TEXT,
    specific_objective_4 TEXT,
    
    justification TEXT,
    introduction TEXT,
    summary TEXT,
    
    -- Tracking
    start_date DATE,
    estimated_closing_date DATE,
    
    -- Part 3: Approvals & State Machine
    coordinator_id UUID REFERENCES profiles(id),
    tutor_id UUID REFERENCES profiles(id),
    
    -- State 1: Anteproyecto
    is_pre_project_approved BOOLEAN DEFAULT FALSE,
    pre_project_approved_at TIMESTAMPTZ,
    
    -- State 2: Recibido
    is_project_received BOOLEAN DEFAULT FALSE,
    project_received_at TIMESTAMPTZ,
    
    -- State 3: Final
    is_final_project_approved BOOLEAN DEFAULT FALSE,
    final_project_approved_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. AUDIT LOGGING SYSTEM
-- -----------------------------------------------------

CREATE TABLE audit_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    table_name TEXT NOT NULL,
    record_id TEXT NOT NULL,
    operation TEXT NOT NULL, -- INSERT, UPDATE
    changed_by UUID REFERENCES auth.users(id),
    changed_at TIMESTAMPTZ DEFAULT NOW(),
    old_data JSONB,
    new_data JSONB
);

-- Function to handle audit logging
CREATE OR REPLACE FUNCTION log_audit_event()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO audit_logs (table_name, record_id, operation, changed_by, new_data)
        VALUES (TG_TABLE_NAME, NEW.id::TEXT, 'INSERT', auth.uid(), row_to_json(NEW)::JSONB);
        RETURN NEW;
    ELSIF (TG_OP = 'UPDATE') THEN
        INSERT INTO audit_logs (table_name, record_id, operation, changed_by, changed_at, old_data, new_data)
        VALUES (TG_TABLE_NAME, NEW.id::TEXT, 'UPDATE', auth.uid(), NOW(), row_to_json(OLD)::JSONB, row_to_json(NEW)::JSONB);
        RETURN NEW;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 6. IMMUTABILITY & MAINTENANCE TRIGGERS
-- -----------------------------------------------------

-- Function to update 'updated_at' timestamp
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function to prevent deletion (Immutability)
CREATE OR REPLACE FUNCTION prevent_deletion()
RETURNS TRIGGER AS $$
BEGIN
    RAISE EXCEPTION 'Deletion is not allowed on this table. Records are immutable.';
END;
$$ LANGUAGE plpgsql;

-- Apply Triggers to Tables

-- Projects: Audit, No Delete, Auto Update
CREATE TRIGGER audit_projects_changes AFTER INSERT OR UPDATE ON projects FOR EACH ROW EXECUTE FUNCTION log_audit_event();
CREATE TRIGGER prevent_projects_delete BEFORE DELETE ON projects FOR EACH ROW EXECUTE FUNCTION prevent_deletion();
CREATE TRIGGER update_projects_timestamp BEFORE UPDATE ON projects FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- Students: Audit, No Delete, Auto Update
CREATE TRIGGER audit_students_changes AFTER INSERT OR UPDATE ON students FOR EACH ROW EXECUTE FUNCTION log_audit_event();
CREATE TRIGGER prevent_students_delete BEFORE DELETE ON students FOR EACH ROW EXECUTE FUNCTION prevent_deletion();
CREATE TRIGGER update_students_timestamp BEFORE UPDATE ON students FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- Audit Logs: No Delete (True Audit Trail)
CREATE TRIGGER prevent_audit_delete BEFORE DELETE ON audit_logs FOR EACH ROW EXECUTE FUNCTION prevent_deletion();

-- 7. ROW LEVEL SECURITY (RLS)
-- -----------------------------------------------------

-- Enable RLS on all tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE faculties ENABLE ROW LEVEL SECURITY;
ALTER TABLE schools ENABLE ROW LEVEL SECURITY;
ALTER TABLE institutions ENABLE ROW LEVEL SECURITY;

-- Helper function to get current user's profile data (Performance optimization)
-- Note: In production, consider using Custom Claims in JWT to avoid this join, 
-- but this is the standard SQL-only approach.
CREATE OR REPLACE FUNCTION get_my_role()
RETURNS TABLE (role app_role, faculty_id BIGINT, school_id BIGINT) AS $$
    SELECT role, assigned_faculty_id, assigned_school_id 
    FROM profiles 
    WHERE id = auth.uid();
$$ LANGUAGE sql SECURITY DEFINER STABLE;

-- POLICIES

-- A. Lookups (Faculties, Schools, Institutions)
-- Everyone can read lookups
CREATE POLICY "Public read lookups" ON faculties FOR SELECT TO authenticated USING (true);
CREATE POLICY "Public read schools" ON schools FOR SELECT TO authenticated USING (true);
CREATE POLICY "Public read institutions" ON institutions FOR SELECT TO authenticated USING (true);

-- B. Profiles
-- Users can read their own profile
CREATE POLICY "Read own profile" ON profiles FOR SELECT TO authenticated USING (auth.uid() = id);
-- High-level admins can read all profiles
CREATE POLICY "Admins read all profiles" ON profiles FOR SELECT TO authenticated 
USING (
    (SELECT role FROM get_my_role()) IN ('rector', 'vicerector', 'planning', 'dean', 'director', 'coordinator')
);

-- C. Students
-- Student: Read own data
CREATE POLICY "Student read own" ON students FOR SELECT TO authenticated USING (auth.uid() = id);

-- Global Admins: Read all
CREATE POLICY "Global admins read all students" ON students FOR SELECT TO authenticated 
USING ((SELECT role FROM get_my_role()) IN ('rector', 'vicerector', 'planning'));

-- Deans: Read/Write students in their Faculty
CREATE POLICY "Deans access faculty students" ON students FOR ALL TO authenticated 
USING (
    (SELECT role FROM get_my_role()) = 'dean' AND 
    faculty_id = (SELECT faculty_id FROM get_my_role())
);

-- Directors/Coordinators: Read/Write students in their School
CREATE POLICY "Directors access school students" ON students FOR ALL TO authenticated 
USING (
    (SELECT role FROM get_my_role()) IN ('director', 'coordinator') AND 
    school_id = (SELECT school_id FROM get_my_role())
);

-- D. Projects
-- Student: Read own project
CREATE POLICY "Student read own project" ON projects FOR SELECT TO authenticated 
USING (student_id = auth.uid());

-- Student: Insert own project
CREATE POLICY "Student create own project" ON projects FOR INSERT TO authenticated 
WITH CHECK (student_id = auth.uid());

-- Student: Update own project (Only if not yet approved/finalized - optional logic, keeping simple for now)
CREATE POLICY "Student update own project" ON projects FOR UPDATE TO authenticated 
USING (student_id = auth.uid());

-- Global Admins: Read all
CREATE POLICY "Global admins read all projects" ON projects FOR SELECT TO authenticated 
USING ((SELECT role FROM get_my_role()) IN ('rector', 'vicerector', 'planning'));

-- Deans: Access projects in their Faculty (via Student link)
CREATE POLICY "Deans access faculty projects" ON projects FOR ALL TO authenticated 
USING (
    (SELECT role FROM get_my_role()) = 'dean' AND 
    EXISTS (
        SELECT 1 FROM students s 
        WHERE s.id = projects.student_id 
        AND s.faculty_id = (SELECT faculty_id FROM get_my_role())
    )
);

-- Directors/Coordinators: Access projects in their School
CREATE POLICY "Directors access school projects" ON projects FOR ALL TO authenticated 
USING (
    (SELECT role FROM get_my_role()) IN ('director', 'coordinator') AND 
    EXISTS (
        SELECT 1 FROM students s 
        WHERE s.id = projects.student_id 
        AND s.school_id = (SELECT school_id FROM get_my_role())
    )
);

-- E. Audit Logs
-- Admins can view logs, no one can insert/update manually (handled by triggers)
CREATE POLICY "Admins view logs" ON audit_logs FOR SELECT TO authenticated 
USING ((SELECT role FROM get_my_role()) IN ('rector', 'vicerector', 'planning', 'dean', 'director'));

-- INDEXES FOR PERFORMANCE
-- -----------------------------------------------------
CREATE INDEX idx_students_school ON students(school_id);
CREATE INDEX idx_students_faculty ON students(faculty_id);
CREATE INDEX idx_projects_student ON projects(student_id);
CREATE INDEX idx_projects_institution ON projects(institution_id);
CREATE INDEX idx_audit_record ON audit_logs(record_id);
CREATE INDEX idx_profiles_role ON profiles(role);
